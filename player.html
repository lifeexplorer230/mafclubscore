<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ - MafClub.biz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .player-header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .player-name {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .role-stats {
            display: grid;
            gap: 15px;
        }

        .role-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .role-info {
            text-align: right;
        }

        .recent-games-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recent-games-table th,
        .recent-games-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .recent-games-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .points-positive {
            color: #4ade80;
            font-weight: bold;
        }

        .points-negative {
            color: #f87171;
            font-weight: bold;
        }

        .clickable-link {
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
        }

        .clickable-link:hover {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #f87171;
            font-size: 1.2rem;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-scroll-hint {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .player-name {
                font-size: 2rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }

            .recent-games-table {
                font-size: 0.85rem;
            }

            .recent-games-table th,
            .recent-games-table td {
                padding: 8px 4px;
            }

            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É "–î–∞—Ç–∞" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .hide-mobile {
                display: none;
            }

            .mobile-scroll-hint {
                display: block;
            }
        }

        /* –î–ª—è –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 360px) {
            .recent-games-table {
                font-size: 0.75rem;
            }

            .recent-games-table th,
            .recent-games-table td {
                padding: 6px 3px;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <nav style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap;">
            <a href="rating.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                üèÜ –ì–ª–∞–≤–Ω–∞—è
            </a>
            <a href="day-stats.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
            </a>
            <a href="rating-rules.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                üìñ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥
            </a>
        </nav>

        <div id="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
        </div>
    </div>

    <script>
        // ========== XSS PROTECTION ==========
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function createElement(tag, attributes = {}, children = []) {
            const element = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => {
                if (key === 'textContent') {
                    element.textContent = value;
                } else if (key === 'className') {
                    element.className = value;
                } else {
                    element.setAttribute(key, escapeHtml(value));
                }
            });
            children.forEach(child => {
                if (typeof child === 'string') {
                    element.appendChild(document.createTextNode(child));
                } else {
                    element.appendChild(child);
                }
            });
            return element;
        }

        function clearElement(element) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }
        // ====================================

        async function loadPlayerStats() {
            const urlParams = new URLSearchParams(window.location.search);
            const playerId = urlParams.get('id');

            if (!playerId) {
                // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
                const content = document.getElementById('content');
                clearElement(content);
                const errorDiv = createElement('div', { className: 'error' }, [
                    '‚ö†Ô∏è ID –∏–≥—Ä–æ–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω'
                ]);
                content.appendChild(errorDiv);
                return;
            }

            try {
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ API
                let response = await fetch(`/api/players/${playerId}`);

                // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ JSON
                if (!response.ok) {
                    console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ data/players/*.json');
                    response = await fetch(`data/players/${playerId}.json`);
                }

                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞');
                }

                const stats = await response.json();
                displayPlayerStats(stats);
            } catch (error) {
                // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—à–∏–±–∫–∏
                const content = document.getElementById('content');
                clearElement(content);
                const errorDiv = createElement('div', { className: 'error' }, [
                    '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ',
                    error.message
                ]);
                content.appendChild(errorDiv);
            }
        }

        function displayPlayerStats(stats) {
            // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {player: {...}, games: [...]}
            const player = stats.player;
            const games = stats.games || [];

            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const avgPoints = player.games_played > 0
                ? (player.total_points / player.games_played).toFixed(2)
                : '0.00';

            // –ù–∞—Ö–æ–¥–∏–º –ª—É—á—à—É—é –∏–≥—Ä—É
            let bestGame = 0;
            if (games.length > 0) {
                const points = games.map(g => g.points);
                bestGame = Math.max(...points);
            }

            // ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            let html = `
                <div class="player-header">
                    <div class="player-name">üë§ ${escapeHtml(player.name)}</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${player.games_played || 0}</div>
                        <div class="stat-label">–ò–≥—Ä</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value ${player.total_points > 0 ? 'points-positive' : player.total_points < 0 ? 'points-negative' : ''}">
                            ${player.total_points > 0 ? '+' : ''}${player.total_points || 0}
                        </div>
                        <div class="stat-label">–í—Å–µ–≥–æ –æ—á–∫–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgPoints}</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value points-positive">${player.wins || 0}</div>
                        <div class="stat-label">–ü–æ–±–µ–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${bestGame > 0 ? '+' : ''}${bestGame}</div>
                        <div class="stat-label">–õ—É—á—à–∞—è –∏–≥—Ä–∞</div>
                    </div>
                </div>
            `;

            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ä–æ–ª—è–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            const roleStats = {};
            games.forEach(game => {
                if (!roleStats[game.role]) {
                    roleStats[game.role] = {
                        games_count: 0,
                        total_points: 0
                    };
                }
                roleStats[game.role].games_count++;
                roleStats[game.role].total_points += game.points;
            });

            const roles = Object.keys(roleStats);
            if (roles.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è–º</div>
                        <div class="role-stats">
                `;

                roles.forEach(roleName => {
                    const role = roleStats[roleName];
                    const avgPoints = (role.total_points / role.games_count).toFixed(2);
                    html += `
                        <div class="role-item">
                            <div>
                                <div class="role-name">${escapeHtml(roleName)}</div>
                                <div>${role.games_count} ${role.games_count === 1 ? '–∏–≥—Ä–∞' : role.games_count < 5 ? '–∏–≥—Ä—ã' : '–∏–≥—Ä'}</div>
                            </div>
                            <div class="role-info">
                                <div class="${role.total_points > 0 ? 'points-positive' : role.total_points < 0 ? 'points-negative' : ''}">
                                    ${role.total_points > 0 ? '+' : ''}${role.total_points} –æ—á–∫–æ–≤
                                </div>
                                <div>—Å—Ä–µ–¥–Ω–µ–µ: ${avgPoints}</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã
            if (games && games.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">üéÆ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
                        <div class="table-wrapper">
                            <table class="recent-games-table">
                                <thead>
                                    <tr>
                                        <th class="hide-mobile">–î–∞—Ç–∞</th>
                                        <th>–ò–≥—Ä–∞</th>
                                        <th>–†–æ–ª—å</th>
                                        <th class="hide-mobile">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                        <th>–û—á–∫–∏</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                games.forEach(game => {
                    const pointsClass = game.points > 0 ? 'points-positive' :
                                       game.points < 0 ? 'points-negative' : '';

                    const dateFormatted = new Date(game.date).toLocaleDateString('ru-RU');

                    html += `
                        <tr>
                            <td class="hide-mobile"><a href="day-games.html?date=${escapeHtml(game.date)}" class="clickable-link">${dateFormatted}</a></td>
                            <td><a href="game-details.html?id=${game.game_id}" class="clickable-link">#${game.game_number || 1}</a></td>
                            <td>${escapeHtml(game.role)}</td>
                            <td class="hide-mobile">${game.winner === '–ú–∏—Ä–Ω—ã–µ' ? 'üè°' : 'üî´'} ${escapeHtml(game.winner)}</td>
                            <td class="${pointsClass}">${game.points > 0 ? '+' : ''}${game.points}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                            <div class="mobile-scroll-hint">‚Üê –°–≤–∞–π–ø –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ‚Üí</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('content').innerHTML = html;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = loadPlayerStats;
    </script>

    <a href="login.html" style="position: fixed; bottom: 10px; right: 10px; opacity: 0.5; font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; text-decoration: none; color: white; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='0.5'">
        v1.2.0
    </a>
</body>
</html>
