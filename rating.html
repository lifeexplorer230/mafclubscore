<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤ - –ú–ê–§-–ö–ª—É–±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .rating-table th,
        .rating-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rating-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .rating-table tbody tr {
            transition: all 0.3s;
            cursor: pointer;
        }

        .rating-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rank-cell {
            font-weight: bold;
            font-size: 1.2rem;
            color: #fbbf24;
            width: 60px;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-scroll-hint {
            display: none;
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        .rank-1 { color: #ffd700; font-size: 1.5rem; }
        .rank-2 { color: #c0c0c0; font-size: 1.4rem; }
        .rank-3 { color: #cd7f32; font-size: 1.3rem; }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .points-positive {
            color: #4ade80;
            font-weight: bold;
        }

        .points-negative {
            color: #f87171;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #f87171;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .rating-table {
                font-size: 0.85rem;
            }

            .rating-table th,
            .rating-table td {
                padding: 8px 4px;
            }

            .rank-cell {
                width: 40px;
                font-size: 1rem;
            }

            .rank-1 { font-size: 1.2rem; }
            .rank-2 { font-size: 1.15rem; }
            .rank-3 { font-size: 1.1rem; }

            .header h1 {
                font-size: 2rem;
            }

            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ "–ò–≥—Ä" –∏ "–ü–æ–±–µ–¥" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .hide-mobile {
                display: none;
            }

            .mobile-scroll-hint {
                display: block;
            }
        }

        /* –î–ª—è –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 360px) {
            .rating-table {
                font-size: 0.75rem;
            }

            .rating-table th,
            .rating-table td {
                padding: 6px 3px;
            }

            .container {
                padding: 15px;
            }
        }

        .rating-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: all 0.3s;
        }

        .rating-table th.sortable:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .rating-table th.sortable.active {
            color: #fbbf24;
        }

        .rating-table th.sortable::after {
            content: '';
            margin-left: 5px;
            opacity: 0.3;
        }

        .rating-table th.sortable.active::after {
            opacity: 1;
            content: '‚ñº';
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <nav style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap;">
            <a href="rating.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.3); border-radius: 10px; transition: all 0.3s; border: 2px solid rgba(255, 255, 255, 0.5);" onmouseover="this.style.background='rgba(255, 255, 255, 0.4)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.3)'">
                üèÜ –ì–ª–∞–≤–Ω–∞—è
            </a>
            <a href="day-stats.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
            </a>
            <a href="rating-rules.html" style="color: white; text-decoration: none; font-size: 1rem; padding: 12px 24px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'">
                üìñ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥
            </a>
        </nav>

        <div class="header">
            <h1>üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h1>
            <p>MafClub.biz</p>
        </div>

        <div id="content">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</div>
        </div>

    </div>

    <script type="module">
        // ========== IMPORTS ==========
        import api from './js/modules/api.js';
        import { createElement, clearElement, showError } from './js/modules/ui.js';

        // ====================================

        let allPlayers = [];
        let currentSortBy = 'points';

        async function loadRating() {
            console.log('üîÑ loadRating started');
            try {
                console.log('üì° Calling api.getRating()...');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ API —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å
                const data = await api.getRating();
                console.log('‚úÖ API response:', data);

                // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success: true, players: [...]}
                if (data.success && data.players) {
                    console.log(`üìä Got ${data.players.length} players`);
                    allPlayers = data.players;
                    displayRating();
                    console.log('‚úÖ displayRating() completed');
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–∏–ª–∏—Ç—É showError –∏–∑ –º–æ–¥—É–ª—è ui.js
                showError('#content', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', error.message);
            }
        }

        function sortBy(criteria) {
            currentSortBy = criteria;
            displayRating();
        }

        function displayRating() {
            const rating = [...allPlayers];
            if (!rating || rating.length === 0) {
                // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
                const content = document.getElementById('content');
                clearElement(content);

                const emptyDiv = createElement('div', { className: 'error' }, [
                    'üìä –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è'
                ]);

                content.appendChild(emptyDiv);
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é
            rating.sort((a, b) => {
                switch(currentSortBy) {
                    case 'points':
                        return b.total_points - a.total_points;
                    case 'games':
                        return b.games_played - a.games_played;
                    case 'average':
                        const avgA = a.games_played > 0 ? a.total_points / a.games_played : 0;
                        const avgB = b.games_played > 0 ? b.total_points / b.games_played : 0;
                        return avgB - avgA;
                    case 'wins':
                        return b.wins - a.wins;
                    default:
                        return b.total_points - a.total_points;
                }
            });

            // ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const getValue = (player) => {
                switch(currentSortBy) {
                    case 'points':
                        return player.total_points;
                    case 'games':
                        return player.games_played;
                    case 'average':
                        return player.games_played > 0 ? player.total_points / player.games_played : 0;
                    case 'wins':
                        return player.wins;
                    default:
                        return player.total_points;
                }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–Ω–≥ –∫ –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É
            let rank = 1;
            rating.forEach((player, index) => {
                player.rank = rank;
                if (index < rating.length - 1 && getValue(rating[index + 1]) !== getValue(player)) {
                    rank = index + 2;
                }
            });

            // –°–æ–∑–¥–∞–µ–º table wrapper
            const tableWrapper = createElement('div', { className: 'table-wrapper' });

            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            const table = createElement('table', { className: 'rating-table' });

            // –°–æ–∑–¥–∞–µ–º thead
            const thead = createElement('thead');
            const headerRow = createElement('tr');

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
            headerRow.appendChild(createElement('th', { textContent: '–ú–µ—Å—Ç–æ' }));
            headerRow.appendChild(createElement('th', { textContent: '–ò–≥—Ä–æ–∫' }));

            headerRow.appendChild(createElement('th', {
                className: `sortable hide-mobile ${currentSortBy === 'games' ? 'active' : ''}`,
                textContent: '–ò–≥—Ä',
                onclick: () => sortBy('games')
            }));

            headerRow.appendChild(createElement('th', {
                className: `sortable ${currentSortBy === 'points' ? 'active' : ''}`,
                textContent: '–û—á–∫–∏',
                onclick: () => sortBy('points')
            }));

            headerRow.appendChild(createElement('th', {
                className: `sortable ${currentSortBy === 'average' ? 'active' : ''}`,
                textContent: '–°—Ä–µ–¥–Ω–µ–µ',
                onclick: () => sortBy('average')
            }));

            headerRow.appendChild(createElement('th', {
                className: `sortable hide-mobile ${currentSortBy === 'wins' ? 'active' : ''}`,
                textContent: '–ü–æ–±–µ–¥',
                onclick: () => sortBy('wins')
            }));

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // –°–æ–∑–¥–∞–µ–º tbody
            const tbody = createElement('tbody');

            rating.forEach(player => {
                const rankClass = player.rank <= 3 ? `rank-${player.rank}` : '';
                const pointsClass = player.total_points > 0 ? 'points-positive' :
                                   player.total_points < 0 ? 'points-negative' : '';

                const avgPoints = player.games_played > 0
                    ? (player.total_points / player.games_played).toFixed(2)
                    : '0.00';

                const row = createElement('tr', {
                    onclick: () => openPlayer(player.id)
                });

                row.appendChild(createElement('td', {
                    className: `rank-cell ${rankClass}`,
                    textContent: String(player.rank)
                }));

                row.appendChild(createElement('td', {
                    className: 'player-name',
                    textContent: player.name
                }));

                row.appendChild(createElement('td', {
                    className: 'hide-mobile',
                    textContent: String(player.games_played)
                }));

                row.appendChild(createElement('td', {
                    className: pointsClass,
                    textContent: `${player.total_points > 0 ? '+' : ''}${player.total_points}`
                }));

                row.appendChild(createElement('td', {
                    textContent: avgPoints
                }));

                row.appendChild(createElement('td', {
                    className: 'hide-mobile',
                    textContent: String(player.wins)
                }));

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableWrapper.appendChild(table);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            const hint = createElement('div', {
                className: 'mobile-scroll-hint',
                textContent: '‚Üê –°–≤–∞–π–ø –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ‚Üí'
            });
            tableWrapper.appendChild(hint);

            // –û—á–∏—â–∞–µ–º content –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
            const content = document.getElementById('content');
            clearElement(content);
            content.appendChild(tableWrapper);
        }

        function openPlayer(playerId) {
            window.location.href = `player.html?id=${playerId}`;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = loadRating;
    </script>

    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ -->
    <script src="/shared/version-loader.js"></script>
</body>
</html>
