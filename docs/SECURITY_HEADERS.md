# Security Headers Guide

## –û–±–∑–æ—Ä

Security headers –∑–∞—â–∏—â–∞—é—Ç web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç XSS, clickjacking, MITM –∏ –¥—Ä—É–≥–∏—Ö –∞—Ç–∞–∫.

### –ó–∞—â–∏—Ç–∞ –æ—Ç:
- üõ°Ô∏è **XSS (Cross-Site Scripting)** - —á–µ—Ä–µ–∑ CSP
- üîí **Clickjacking** - —á–µ—Ä–µ–∑ X-Frame-Options
- üîê **MITM** - —á–µ—Ä–µ–∑ HSTS
- üìù **MIME sniffing** - —á–µ—Ä–µ–∑ X-Content-Type-Options
- üéØ **Information leakage** - —á–µ—Ä–µ–∑ Referrer-Policy

## –û—Å–Ω–æ–≤–Ω—ã–µ Headers

### 1. Content-Security-Policy (CSP)

–°–∞–º—ã–π –º–æ—â–Ω—ã–π header –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS.

```javascript
import { withSecurityHeaders, createCSP } from './shared/security-headers.js';

const csp = createCSP({
  defaultSrc: ["'self'"],
  scriptSrc: ["'self'", "'unsafe-inline'"],  // TODO: remove unsafe-inline
  styleSrc: ["'self'", "'unsafe-inline'"],
  imgSrc: ["'self'", 'data:', 'https:'],
  connectSrc: ["'self'"],
  frameAncestors: ["'none'"]
});

export default withSecurityHeaders(handler, {
  custom: {
    'Content-Security-Policy': csp
  }
});
```

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç:**
- Inline scripts –±–µ–∑ nonce
- Eval() –∏ –ø–æ–¥–æ–±–Ω—ã–µ
- –ó–∞–≥—Ä—É–∑–∫—É —Å –Ω–µ–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- Embedding –≤ iframe

### 2. Strict-Transport-Security (HSTS)

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS.

```javascript
'Strict-Transport-Security': 'max-age=31536000; includeSubDomains; preload'
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç HTTP ‚Üí HTTPS
- –ó–∞—â–∏—Ç–∞ –æ—Ç SSL stripping –∞—Ç–∞–∫
- –î–µ–π—Å—Ç–≤—É–µ—Ç 1 –≥–æ–¥ (31536000 —Å–µ–∫—É–Ω–¥)

### 3. X-Frame-Options

–ó–∞—â–∏—Ç–∞ –æ—Ç clickjacking.

```javascript
'X-Frame-Options': 'DENY'  // –ò–ª–∏ SAMEORIGIN
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- `DENY` - –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—Å–µ frames
- `SAMEORIGIN` - —Ç–æ–ª—å–∫–æ —Å —Ç–æ–≥–æ –∂–µ –¥–æ–º–µ–Ω–∞

### 4. X-Content-Type-Options

–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç MIME sniffing.

```javascript
'X-Content-Type-Options': 'nosniff'
```

**–ó–∞—â–∏—Ç–∞:**
- –ë—Ä–∞—É–∑–µ—Ä –Ω–µ —É–≥–∞–¥—ã–≤–∞–µ—Ç Content-Type
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç XSS —á–µ—Ä–µ–∑ –Ω–µ–≤–µ—Ä–Ω—ã–µ MIME types

### 5. Referrer-Policy

–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç Referer header.

```javascript
'Referrer-Policy': 'strict-origin-when-cross-origin'
```

**–û–ø—Ü–∏–∏:**
- `no-referrer` - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
- `strict-origin` - —Ç–æ–ª—å–∫–æ origin –Ω–∞ HTTPS
- `strict-origin-when-cross-origin` - –ø–æ–ª–Ω—ã–π URL –Ω–∞ same-origin

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ (–¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)

```javascript
import { withSecurityHeaders } from './shared/security-headers.js';

async function handler(request) {
  return new Response('<html>...</html>', {
    headers: { 'Content-Type': 'text/html' }
  });
}

// –î–æ–±–∞–≤–ª—è–µ–º security headers
export default withSecurityHeaders(handler);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; ...
Strict-Transport-Security: max-age=31536000; includeSubDomains
Referrer-Policy: strict-origin-when-cross-origin
```

### –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º (production)

```javascript
export default withSecurityHeaders(handler, {
  strict: true  // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
});
```

**–û—Ç–ª–∏—á–∏—è strict mode:**
- CSP –±–µ–∑ `unsafe-inline` –∏ `unsafe-eval`
- X-Frame-Options: DENY (–≤–º–µ—Å—Ç–æ SAMEORIGIN)
- Cross-Origin isolation headers

### –î–ª—è API endpoints

```javascript
import { withAPISecurityHeaders } from './shared/security-headers.js';

// –£–ø—Ä–æ—â—ë–Ω–Ω—ã–µ headers –¥–ª—è JSON API
export default withAPISecurityHeaders(apiHandler);
```

**API headers:**
```
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000
Referrer-Policy: no-referrer
Cross-Origin-Resource-Policy: same-origin
```

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ headers

```javascript
export default withSecurityHeaders(handler, {
  custom: {
    'X-Custom-Header': 'value',
    'Content-Security-Policy': "default-src 'self'; script-src 'self' cdn.example.com"
  }
});
```

## CSP —Å Nonce

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline scripts.

### Backend

```javascript
import { withCSPNonce } from './shared/security-headers.js';

async function handler(request) {
  const nonce = request.cspNonce;  // Generated by middleware

  const html = `
    <html>
      <head>
        <script nonce="${nonce}">
          console.log('Safe inline script');
        </script>
      </head>
    </html>
  `;

  return new Response(html, {
    headers: { 'Content-Type': 'text/html' }
  });
}

export default withCSPNonce(handler);
```

**CSP header:**
```
Content-Security-Policy: script-src 'self' 'nonce-abc123xyz'
```

**HTML:**
```html
<!-- ‚úÖ Allowed - has matching nonce -->
<script nonce="abc123xyz">...</script>

<!-- ‚ùå Blocked - no nonce -->
<script>alert('XSS')</script>
```

## CORS Headers

–î–ª—è cross-origin API requests.

```javascript
import { withCORS } from './shared/security-headers.js';

export default withCORS(apiHandler, {
  origin: 'https://example.com',  // Specific origin
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
});
```

**CORS headers:**
```
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET, POST
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true
```

## –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞

–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π middleware.

```javascript
import { withFullSecurity } from './shared/security-headers.js';

export default withFullSecurity(handler, {
  strict: true,   // –°—Ç—Ä–æ–≥–∏–µ security headers
  nonce: true,    // CSP —Å nonce
  cors: {         // CORS –¥–ª—è API
    origin: 'https://example.com'
  }
});
```

## Validation & Monitoring

### –ü—Ä–æ–≤–µ—Ä–∫–∞ headers

```javascript
import { validateSecurityHeaders } from './shared/security-headers.js';

const response = await fetch('https://example.com');
const validation = validateSecurityHeaders(response);

console.log(validation);
// {
//   score: 100,
//   present: ['X-Content-Type-Options', 'X-Frame-Options', ...],
//   missing: [],
//   isSecure: true
// }
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

```javascript
import { getSecurityRecommendations } from './shared/security-headers.js';

const recommendations = getSecurityRecommendations(response);
console.log(recommendations);
// [
//   "Remove 'unsafe-inline' from CSP and use nonces",
//   "Add HSTS header to enforce HTTPS"
// ]
```

## Best Practices

### 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ strict mode –≤ production

```javascript
// ‚úÖ GOOD
export default withSecurityHeaders(handler, {
  strict: process.env.NODE_ENV === 'production'
});

// ‚ùå BAD - relaxed security in production
export default withSecurityHeaders(handler);
```

### 2. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–∂–µ—Å—Ç–æ—á–∞–π—Ç–µ CSP

**Step 1:** Report-only mode
```javascript
'Content-Security-Policy-Report-Only': "default-src 'self'; report-uri /csp-report"
```

**Step 2:** –£–±–∏—Ä–∞–µ–º unsafe-inline
```javascript
'Content-Security-Policy': "default-src 'self'; script-src 'self'"
```

**Step 3:** –î–æ–±–∞–≤–ª—è–µ–º nonce
```javascript
withCSPNonce(handler)
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ subresource integrity

```html
<script
  src="https://cdn.example.com/library.js"
  integrity="sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/ux..."
  crossorigin="anonymous"></script>
```

### 4. –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å security scanners

```bash
# Mozilla Observatory
https://observatory.mozilla.org/

# Security Headers
https://securityheaders.com/

# CSP Evaluator
https://csp-evaluator.withgoogle.com/
```

### 5. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ CSP violations

```javascript
// CSP report endpoint
export async function POST(request) {
  const report = await request.json();
  console.error('CSP Violation:', report);

  // Send to monitoring service
  await sendToSentry(report);

  return new Response(null, { status: 204 });
}
```

## Security Score

### Before (–±–µ–∑ headers):

```
Security Score: 0/100
Missing:
- X-Content-Type-Options
- X-Frame-Options
- X-XSS-Protection
- Content-Security-Policy
- Strict-Transport-Security
- Referrer-Policy

Vulnerable to:
- XSS attacks
- Clickjacking
- MIME sniffing
- MITM attacks
```

### After (—Å headers):

```
Security Score: 100/100
Present:
‚úÖ X-Content-Type-Options: nosniff
‚úÖ X-Frame-Options: DENY
‚úÖ X-XSS-Protection: 1; mode=block
‚úÖ Content-Security-Policy: ...
‚úÖ Strict-Transport-Security: ...
‚úÖ Referrer-Policy: ...

Protected from:
‚úÖ XSS attacks
‚úÖ Clickjacking
‚úÖ MIME sniffing
‚úÖ MITM attacks
```

## Vercel Configuration

**vercel.json:**
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains; preload"
        },
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; script-src 'self'; style-src 'self'"
        }
      ]
    }
  ]
}
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ middleware:**
```javascript
// middleware.js
import { withSecurityHeaders } from './shared/security-headers.js';

export default withSecurityHeaders((request) => {
  return NextResponse.next();
}, { strict: true });
```

## Common CSP Violations

### Inline scripts

```html
<!-- ‚ùå Blocked -->
<script>alert('Hello')</script>

<!-- ‚úÖ Allowed - with nonce -->
<script nonce="${nonce}">alert('Hello')</script>

<!-- ‚úÖ Allowed - external -->
<script src="/script.js"></script>
```

### Event handlers

```html
<!-- ‚ùå Blocked -->
<button onclick="alert('Click')">Button</button>

<!-- ‚úÖ Allowed - addEventListener -->
<button id="btn">Button</button>
<script>
  document.getElementById('btn').addEventListener('click', () => {
    alert('Click');
  });
</script>
```

### Inline styles

```html
<!-- ‚ùå Blocked -->
<div style="color: red">Text</div>

<!-- ‚úÖ Allowed - with nonce -->
<style nonce="${nonce}">
  .red { color: red; }
</style>

<!-- ‚úÖ Allowed - external -->
<link rel="stylesheet" href="/style.css">
```

## Troubleshooting

### CSP –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –≤ whitelist
```javascript
createCSP({
  scriptSrc: ["'self'", 'https://cdn.example.com']
})
```

### CORS errors

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤—å—Ç–µ CORS headers
```javascript
withCORS(handler, {
  origin: 'https://frontend.example.com'
})
```

### Mixed content warnings

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ HTTPS URLs
```javascript
createCSP({
  upgradeInsecureRequests: true  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ upgrade HTTP ‚Üí HTTPS
})
```

## Resources

- [MDN: CSP](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [OWASP: Security Headers](https://owasp.org/www-project-secure-headers/)
- [Security Headers Checker](https://securityheaders.com/)
- [CSP Evaluator](https://csp-evaluator.withgoogle.com/)
