<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–≤–æ–¥ –∏–≥—Ä - –ú–ê–§-–ö–ª—É–±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input.existing-player {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
        }

        .form-group input.new-player {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
        }

        .autocomplete-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-item:hover {
            background: #f3f4f6;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .btn-primary {
            background: #4ade80;
            border-color: #4ade80;
            color: #1a1a1a;
        }

        .btn-primary:hover {
            background: #22c55e;
        }

        .game-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .game-header {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .player-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .name-input-wrapper {
            position: relative;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #4ade80;
            color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        .error-message {
            background: #f87171;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            margin-top: 20px;
        }

        #loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>

        <div class="header">
            <h1>üéÆ –í–≤–æ–¥ –∏–≥—Ä—ã</h1>
            <p>MafClub.biz</p>
        </div>

        <!-- –®–∞–≥ 1: –î–∞—Ç–∞ –∏–≥—Ä—ã -->
        <div id="step1" class="section">
            <div class="form-group">
                <label for="gameDate">üìÖ –î–∞—Ç–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –¥–Ω—è:</label>
                <input type="date" id="gameDate" required>
            </div>
            <button class="btn btn-primary" onclick="startGame()">–ù–∞—á–∞—Ç—å –≤–≤–æ–¥ –∏–≥—Ä—ã</button>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä -->
        <div id="deleteSection" class="section">
            <div class="game-header">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É</div>
            <div class="form-group">
                <label for="gameToDelete">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:</label>
                <select id="gameToDelete" style="width: 100%; padding: 12px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.9); color: #333; font-size: 1rem;">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            <button class="btn" style="background: rgba(248, 113, 113, 0.3); border-color: #f87171;" onclick="deleteSelectedGame()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–≥—Ä—É</button>
        </div>

        <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∏–≥—Ä -->
        <div id="step2" class="hidden">
            <div id="gamesContainer"></div>

            <div class="section">
                <button class="btn" style="background: rgba(251, 191, 36, 0.3); border-color: #fbbf24;" onclick="fillTestData()">üß™ –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</button>
                <button class="btn btn-primary" onclick="saveGame()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É</button>
                <button class="btn" onclick="resetForm()">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>
        </div>

        <div id="loading" class="hidden">
            <p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <div id="result"></div>
    </div>

    <script src="rating_calculator.js"></script>
    <script>
        // üîê –£–ü–†–û–©–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è)
        (function checkAuth() {
            const isLoggedIn = localStorage.getItem('maf_is_logged_in');
            const username = localStorage.getItem('maf_username');

            if (isLoggedIn !== 'true' || !username) {
                // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–≥–∏–Ω
                console.log('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login.html');
                window.location.href = 'login.html';
                return;
            }

            console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', username);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–ø–∫–µ
            const header = document.querySelector('.header h1');
            if (header) {
                header.innerHTML = `üìù –í–≤–æ–¥ –∏–≥—Ä <span style="font-size: 0.6em; opacity: 0.8;">(${escapeHtml(username)})</span>`;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                const logoutBtn = document.createElement('a');
                logoutBtn.href = '#';
                logoutBtn.className = 'back-link';
                logoutBtn.style.marginLeft = '10px';
                logoutBtn.textContent = 'üö™ –í—ã–π—Ç–∏';
                logoutBtn.onclick = function(e) {
                    e.preventDefault();
                    // –û—á–∏—â–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                    localStorage.removeItem('maf_is_logged_in');
                    localStorage.removeItem('maf_username');
                    localStorage.removeItem('maf_login_time');
                    console.log('üö™ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
                    window.location.href = 'login.html';
                };
                backLink.parentNode.insertBefore(logoutBtn, backLink.nextSibling);
            }
        })();

        // ========== XSS PROTECTION ==========
        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        function createElement(tag, attributes = {}, children = []) {
            const element = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => {
                if (key === 'textContent') element.textContent = value;
                else if (key === 'className') element.className = value;
                else element.setAttribute(key, escapeHtml(value));
            });
            children.forEach(child => element.appendChild(typeof child === 'string' ? document.createTextNode(child) : child));
            return element;
        }
        function clearElement(element) { while (element.firstChild) element.removeChild(element.firstChild); }
        // ====================================

        let gameDate = '';
        let gameNumber = 1; // –í—Å–µ–≥–¥–∞ 1 –∏–≥—Ä–∞ –∑–∞ —Ä–∞–∑

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('gameDate').value = today;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            loadGamesForDeletion();
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä
        async function loadGamesForDeletion() {
            try {
                const response = await fetch('/api/all-games');
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä');
                }

                const data = await response.json();
                const select = document.getElementById('gameToDelete');
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É --</option>';

                if (data.games && data.games.length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä—ã –ø–æ –Ω–æ–º–µ—Ä—É (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                    data.games.sort((a, b) => a.game_number - b.game_number);

                    data.games.forEach(game => {
                        const date = new Date(game.date).toLocaleDateString('ru-RU');
                        const option = document.createElement('option');
                        option.value = game.id;
                        option.textContent = `–ò–≥—Ä–∞ ‚Ññ ${game.game_number} –æ—Ç ${date} (${game.winner === '–ú–∏—Ä–Ω—ã–µ' ? 'üè° –ú–∏—Ä–Ω—ã–µ' : 'üî´ –ú–∞—Ñ–∏—è'})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">–ù–µ—Ç –∏–≥—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</option>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä:', error);
                const select = document.getElementById('gameToDelete');
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∏–≥—Ä—ã
        async function deleteSelectedGame() {
            const select = document.getElementById('gameToDelete');
            const gameId = select.value;

            if (!gameId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            const selectedOption = select.options[select.selectedIndex];
            const gameInfo = selectedOption.textContent;

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–≥—Ä—É?\n\n${gameInfo}\n\n–ò–≥—Ä–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/games/${gameId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer secure-admin-token-94a8bc927efa3b183793399b3c5d5e6b'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(`‚úÖ –ò–≥—Ä–∞ ‚Ññ ${data.deleted_game_number} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä
                    await loadGamesForDeletion();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
            }
        }

        function fillTestData() {
            console.log('üß™ Filling test data...');

            // Test player data: 1-6 –ú–∏—Ä–Ω—ã–µ, 7 –®–µ—Ä–∏—Ñ, 8-9 –ú–∞—Ñ–∏—è, 10 –î–æ–Ω
            // Deaths: 8 (1D), 9 (1N), 10 (2D)
            const testPlayers = [
                { name: 'TestAPIPlayer1', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer2', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer3', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer4', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer5', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer6', role: '–ú–∏—Ä–Ω—ã–π', death: '0' },
                { name: 'TestAPIPlayer7', role: '–®–µ—Ä–∏—Ñ', death: '0' },
                { name: 'TestAPIPlayer8', role: '–ú–∞—Ñ–∏—è', death: '1D' },
                { name: 'TestAPIPlayer9', role: '–ú–∞—Ñ–∏—è', death: '1N' },
                { name: 'TestAPIPlayer10', role: '–î–æ–Ω', death: '2D' }
            ];

            let filled = 0;

            // Fill player names, roles, and deaths
            testPlayers.forEach((player, index) => {
                const playerNum = index + 1;
                const nameInput = document.getElementById(`g1_p${playerNum}_name`);
                const roleSelect = document.getElementById(`g1_p${playerNum}_role`);
                const deathSelect = document.getElementById(`g1_p${playerNum}_death`);

                if (nameInput) {
                    nameInput.value = player.name;
                    nameInput.classList.add('new-player');
                    nameInput.classList.remove('existing-player');
                    filled++;
                }

                if (roleSelect) {
                    roleSelect.value = player.role;
                }

                if (deathSelect) {
                    deathSelect.value = player.death;
                }
            });

            // Set sheriff checks (players 1, 2, 3)
            const sheriffChecks = document.getElementById('g1_sheriff_checks');
            if (sheriffChecks) {
                sheriffChecks.value = '1, 2, 3';
            }

            console.log(`‚úÖ Test data filled: ${filled}/10 players`);
        }

        function startGame() {
            gameDate = document.getElementById('gameDate').value;

            if (!gameDate) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–≥—Ä–æ–≤–æ–≥–æ –¥–Ω—è');
                return;
            }

            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');

            generateGameForm();
        }

        function generateGameForm() {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';

            const gameSection = document.createElement('div');
            gameSection.className = 'game-section';
            gameSection.id = 'game-1';

            let html = `
                <div class="game-header">üéÆ –í–≤–æ–¥ –∏–≥—Ä—ã</div>
            `;

            // 10 –∏–≥—Ä–æ–∫–æ–≤
            for (let p = 1; p <= 10; p++) {
                html += `
                    <div class="player-card">
                        <div class="player-header">–ò–≥—Ä–æ–∫ ${p}</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ò–º—è:</label>
                                <div class="name-input-wrapper">
                                    <input type="text" id="g1_p${p}_name" class="player-name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required autocomplete="off">
                                    <div id="g1_p${p}_autocomplete" class="autocomplete-list"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>–†–æ–ª—å:</label>
                                <select id="g1_p${p}_role">
                                    <option value="–ú–∏—Ä–Ω—ã–π">–ú–∏—Ä–Ω—ã–π</option>
                                    <option value="–®–µ—Ä–∏—Ñ">–®–µ—Ä–∏—Ñ</option>
                                    <option value="–ú–∞—Ñ–∏—è">–ú–∞—Ñ–∏—è</option>
                                    <option value="–î–æ–Ω">–î–æ–Ω</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–ö–æ–≥–¥–∞ —É–±–∏—Ç:</label>
                                <select id="g1_p${p}_death">
                                    <option value="0">0 (–ñ–∏–≤)</option>
                                    <option value="1D">1D (–î–µ–Ω—å 1)</option>
                                    <option value="1N">1N (–ù–æ—á—å 1)</option>
                                    <option value="2D">2D (–î–µ–Ω—å 2)</option>
                                    <option value="2N">2N (–ù–æ—á—å 2)</option>
                                    <option value="3D">3D (–î–µ–Ω—å 3)</option>
                                    <option value="3N">3N (–ù–æ—á—å 3)</option>
                                    <option value="4D">4D (–î–µ–Ω—å 4)</option>
                                    <option value="4N">4N (–ù–æ—á—å 4)</option>
                                    <option value="5D">5D (–î–µ–Ω—å 5)</option>
                                    <option value="5N">5N (–ù–æ—á—å 5)</option>
                                    <option value="6D">6D (–î–µ–Ω—å 6)</option>
                                    <option value="6N">6N (–ù–æ—á—å 6)</option>
                                    <option value="7D">7D (–î–µ–Ω—å 7)</option>
                                    <option value="7N">7N (–ù–æ—á—å 7)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }

            // –ü–æ–ª–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ —à–µ—Ä–∏—Ñ–∞
            html += `
                <div class="form-group">
                    <label>–ü—Ä–æ–≤–µ—Ä–∫–∏ –®–µ—Ä–∏—Ñ–∞ (–Ω–æ–º–µ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                    <input type="text" id="g1_sheriff_checks" placeholder="1,3,5">
                    <small style="opacity: 0.8;">–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∏–º—ë–Ω</small>
                </div>
            `;

            gameSection.innerHTML = html;
            container.appendChild(gameSection);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
            loadPlayersAndSetupAutocomplete();
        }

        let allPlayers = []; // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –±–∞–∑—ã

        async function loadPlayersAndSetupAutocomplete() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
                const response = await fetch('/api/players-list');
                if (response.ok) {
                    const data = await response.json();
                    allPlayers = data.players || [];
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤:', allPlayers.length);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤:', error);
            }

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π —Å –∏–º–µ–Ω–∞–º–∏
            for (let p = 1; p <= 10; p++) {
                const input = document.getElementById(`g1_p${p}_name`);
                const autocompleteDiv = document.getElementById(`g1_p${p}_autocomplete`);

                if (input && autocompleteDiv) {
                    setupAutocomplete(input, autocompleteDiv);
                }
            }
        }

        function setupAutocomplete(input, autocompleteDiv) {
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();

                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                autocompleteDiv.innerHTML = '';
                autocompleteDiv.style.display = 'none';

                if (value.length < 1) {
                    // –ï—Å–ª–∏ –ø—É—Å—Ç–æ - —É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                    input.classList.remove('existing-player', 'new-player');
                    return;
                }

                // –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                const matches = allPlayers.filter(p =>
                    p.name.toLowerCase().includes(value)
                );

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                const exactMatch = allPlayers.find(p =>
                    p.name.toLowerCase() === value
                );

                if (exactMatch) {
                    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –∑–µ–ª—ë–Ω—ã–π
                    input.classList.remove('new-player');
                    input.classList.add('existing-player');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º player_id –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                    input.dataset.playerId = exactMatch.id;
                } else {
                    // –ù–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è - –∂—ë–ª—Ç—ã–π (–Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫)
                    input.classList.remove('existing-player');
                    input.classList.add('new-player');
                    // –£–±–∏—Ä–∞–µ–º player_id –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                    delete input.dataset.playerId;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
                if (matches.length > 0 && !exactMatch) {
                    matches.slice(0, 5).forEach(player => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.textContent = player.name;
                        item.onclick = function() {
                            input.value = player.name;
                            input.classList.remove('new-player');
                            input.classList.add('existing-player');
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º player_id –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ dropdown
                            input.dataset.playerId = player.id;
                            autocompleteDiv.style.display = 'none';
                        };
                        autocompleteDiv.appendChild(item);
                    });
                    autocompleteDiv.style.display = 'block';
                }
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    autocompleteDiv.style.display = 'none';
                }
            });
        }

        // Flag to prevent double-submit
        let isSaving = false;

        async function saveGame() {
            // Prevent double-submit
            if (isSaving) {
                console.warn('‚ö†Ô∏è Save already in progress, ignoring duplicate click');
                return;
            }

            try {
                isSaving = true;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–º—ë–Ω
                const names = [];
                for (let p = 1; p <= 10; p++) {
                    const name = document.getElementById(`g1_p${p}_name`).value.trim();
                    if (name) {
                        if (names.includes(name.toLowerCase())) {
                            alert(`‚ùå –û—à–∏–±–∫–∞: –ò–≥—Ä–æ–∫ "${name}" —É–∫–∞–∑–∞–Ω –¥–≤–∞–∂–¥—ã!\n\n–í –æ–¥–Ω–æ–π –∏–≥—Ä–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏.`);
                            isSaving = false;
                            return;
                        }
                        names.push(name.toLowerCase());
                    }
                }

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
                const gameData = collectGameData(1);
                if (!gameData) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                    isSaving = false;
                    return;
                }

                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const sessionData = {
                    date: gameDate,
                    games: [gameData] // –í—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–æ–π –∏–≥—Ä–æ–π
                };

                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', sessionData);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');

                // Disable save button to prevent double-clicks
                const saveButton = document.querySelector('button.btn-primary');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });

                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
                let result;
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ JSON, —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    const text = await response.text();
                    console.error('Non-JSON response:', text);

                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∑–∞ –æ—à–∏–±–∫–∞
                    if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–º–µ—Å—Ç–æ JSON. –í–æ–∑–º–æ–∂–Ω–æ, endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
                    } else {
                        throw new Error(`–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                    }
                }

                document.getElementById('loading').classList.add('hidden');

                if (response.ok && result.success) {
                    let bestPlayerHtml = '';
                    if (result.best_player_of_day) {
                        const bp = result.best_player_of_day;
                        bestPlayerHtml = `
                            <div style="margin-top: 20px; padding: 20px; background: rgba(255, 215, 0, 0.2); border-radius: 10px;">
                                <div style="font-size: 1.5rem; margin-bottom: 10px;">üèÜ –õ—É—á—à–∏–π –∏–≥—Ä–æ–∫ –¥–Ω—è</div>
                                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 10px;">${escapeHtml(bp.name)}</div>
                                <div style="font-size: 1.1rem;">
                                    –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∑–∞ –≤—ã–∏–≥—Ä—ã—à: <strong>${bp.avg_points_per_win}</strong><br>
                                    –í—Å–µ–≥–æ –æ—á–∫–æ–≤: ${bp.total_points} | –í—ã–∏–≥—Ä—ã—à–µ–π: ${bp.wins} | –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: ${bp.games_played}
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('result').innerHTML = `
                        <div class="section success-message">
                            ‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!<br>
                            ${bestPlayerHtml}
                            <br>
                            <button class="btn btn-primary" onclick="location.reload()">–í–≤–µ—Å—Ç–∏ –µ—â—ë –∏–≥—Ä—É</button>
                            <a href="rating.html" class="btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</a>
                            <a href="day-stats.html" class="btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º</a>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('result').innerHTML = `
                    <div class="section error-message">
                        ‚ùå –û—à–∏–±–∫–∞: ${escapeHtml(error.message)}<br><br>
                        <button class="btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            } finally {
                // Reset flag to allow retry after error or success
                isSaving = false;
            }
        }

        function collectGameData(gameNum) {
            const players = [];
            const sheriffChecks = document.getElementById(`g${gameNum}_sheriff_checks`).value;

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            for (let p = 1; p <= 10; p++) {
                const nameInput = document.getElementById(`g${gameNum}_p${p}_name`);
                const name = nameInput.value.trim();
                const role = document.getElementById(`g${gameNum}_p${p}_role`).value;
                const death = document.getElementById(`g${gameNum}_p${p}_death`).value.trim();

                if (!name) {
                    return null; // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
                }

                const playerData = {
                    name: name,
                    role: role,
                    killed_when: death || '0'
                };

                // –ï—Å–ª–∏ –µ—Å—Ç—å player_id (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–≥—Ä–æ–∫), –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                if (nameInput.dataset.playerId) {
                    playerData.player_id = parseInt(nameInput.dataset.playerId);
                }

                players.push(playerData);
            }

            // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–±–∏–π—Å—Ç–≤
            const killedPlayers = players.filter(p => p.killed_when !== '0' && p.killed_when !== '');
            if (killedPlayers.length < 3) {
                alert(`‚ö†Ô∏è –û–®–ò–ë–ö–ê: –í –∏–≥—Ä–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —É–±–∏—Ç—ã—Ö –∏–≥—Ä–æ–∫–∞!\n\n–°–µ–π—á–∞—Å —É–±–∏—Ç–æ: ${killedPlayers.length}\n\n–ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—è "–ö–æ–≥–¥–∞ —É–±–∏—Ç" –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤.`);
                return null;
            }

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–∑ rating_calculator.js
            const gameResult = calculateGame(players, sheriffChecks);

            // ‚úÖ –í–ê–õ–ò–î–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—á–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            const mafiaPlayers = players.filter(p => p.role === '–ú–∞—Ñ–∏—è' || p.role === '–î–æ–Ω');
            const civilianPlayers = players.filter(p => p.role === '–ú–∏—Ä–Ω—ã–π' || p.role === '–®–µ—Ä–∏—Ñ');
            const aliveMafia = mafiaPlayers.filter(p => p.killed_when === '0' || !p.killed_when).length;
            const aliveCivilian = civilianPlayers.filter(p => p.killed_when === '0' || !p.killed_when).length;

            if (gameResult.winner === '–ú–∏—Ä–Ω—ã–µ' && aliveMafia > 0) {
                alert(`‚ö†Ô∏è –û–®–ò–ë–ö–ê: –ú–∏—Ä–Ω—ã–µ –Ω–µ –º–æ–≥—É—Ç –ø–æ–±–µ–¥–∏—Ç—å, –µ—Å–ª–∏ –∂–∏–≤–∞ –º–∞—Ñ–∏—è!\n\n–ñ–∏–≤—ã—Ö –º–∞—Ñ–∏–π: ${aliveMafia}\n\n–£–∫–∞–∂–∏ –∫–æ–≥–¥–∞ –±—ã–ª–∞ —É–±–∏—Ç–∞ –≤—Å—è –º–∞—Ñ–∏—è.`);
                return null;
            }

            if (gameResult.winner === '–ú–∞—Ñ–∏—è' && aliveCivilian >= aliveMafia && aliveCivilian > 0) {
                alert(`‚ö†Ô∏è –û–®–ò–ë–ö–ê: –ú–∞—Ñ–∏—è –Ω–µ –º–æ–≥—É—Ç –ø–æ–±–µ–¥–∏—Ç—å –ø—Ä–∏ —Ç–∞–∫–æ–º —Ä–∞—Å–∫–ª–∞–¥–µ!\n\n–ñ–∏–≤—ã—Ö –º–∏—Ä–Ω—ã—Ö: ${aliveCivilian}, –ñ–∏–≤—ã—Ö –º–∞—Ñ–∏–π: ${aliveMafia}\n\n–ú–∞—Ñ–∏—è –ø–æ–±–µ–∂–¥–∞–µ—Ç –∫–æ–≥–¥–∞ –º–∏—Ä–Ω—ã—Ö –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ –º–∞—Ñ–∏–∏.`);
                return null;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º name –∏ player_id –∫ –∫–∞–∂–¥–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            const enrichedResults = gameResult.results.map((result, index) => ({
                ...result,
                name: players[index].name,
                player_id: players[index].player_id
            }));

            return {
                // game_number –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                winner: gameResult.winner,
                is_clean_win: gameResult.is_clean_win,
                is_dry_win: gameResult.is_dry_win,
                results: enrichedResults
            };
        }

        function resetForm() {
            if (confirm('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –í—Å–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                location.reload();
            }
        }
    </script>

    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ -->
    <script src="/shared/version-loader.js"></script>
</body>
</html>
