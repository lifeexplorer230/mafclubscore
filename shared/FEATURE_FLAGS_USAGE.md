# Feature Flags - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## üìã –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

Feature flags (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Ñ—É–Ω–∫—Ü–∏–π) - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥, –Ω–æ –¥–µ—Ä–∂–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–π
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ** - —Å–Ω–∞—á–∞–ª–∞ 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ—Ç–æ–º 50%, –ø–æ—Ç–æ–º 100%
3. **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç** - –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –ø—Ä–æ—Å—Ç–æ –≤—ã–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ (–±–µ–∑ –æ—Ç–∫–∞—Ç–∞ –∫–æ–¥–∞)
4. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

## üîß –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ù–∞ –±—ç–∫–µ–Ω–¥–µ (API endpoints)

```javascript
// api/auth/login.js
import { isEnabled } from '../../shared/feature-flags.js';

export default async function handler(request, response) {
  if (isEnabled('NEW_AUTH_SYSTEM')) {
    // –ù–û–í–ê–Ø —Å–∏—Å—Ç–µ–º–∞ —Å JWT
    return handleNewAuth(request, response);
  } else {
    // –°–¢–ê–†–ê–Ø —Å–∏—Å—Ç–µ–º–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
    return handleOldAuth(request, response);
  }
}
```

### –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

```html
<!-- –í –∫–æ–Ω—Ü–µ HTML –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º </body> -->
<script type="module">
  import { isEnabled } from './shared/feature-flags.js';

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏
  if (isEnabled('XSS_PROTECTION')) {
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
    renderSafe(data);
  } else {
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
    renderOld(data);
  }
</script>
```

### –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ

Feature flags –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `window.FeatureFlags`:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –≤ –ª—é–±–æ–º —Å–∫—Ä–∏–ø—Ç–µ
console.log(window.FeatureFlags.getAllFlags());
// => { NEW_AUTH_SYSTEM: false, XSS_PROTECTION: false, ... }

if (window.FeatureFlags.isEnabled('NEW_AUTH_SYSTEM')) {
  console.log('New auth is enabled!');
}
```

## ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞–º–∏

### –ß–µ—Ä–µ–∑ environment variables (Vercel/Production)

–í Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables:

```bash
FEATURE_NEW_AUTH_SYSTEM=true
FEATURE_XSS_PROTECTION=true
FEATURE_STRICT_CORS=false
```

**–í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è environment variables –Ω—É–∂–µ–Ω redeploy!

### –õ–æ–∫–∞–ª—å–Ω–æ (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `.env.local`:

```bash
FEATURE_NEW_AUTH_SYSTEM=true
FEATURE_XSS_PROTECTION=true
```

## üìä –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–ª–∞–≥–æ–≤

### –§–∞–∑–∞ 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- `NEW_AUTH_SYSTEM` - JWT –≤–º–µ—Å—Ç–æ hardcoded credentials
- `XSS_PROTECTION` - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ DOM –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤–º–µ—Å—Ç–æ innerHTML)
- `STRICT_CORS` - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π CORS (–≤–º–µ—Å—Ç–æ `*`)
- `INPUT_VALIDATION` - Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –§–∞–∑–∞ 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `SHARED_HANDLERS` - –û–±—â–∏–µ API handlers (—É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
- `DATABASE_SERVICE` - –°–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è –ë–î

### –§–∞–∑–∞ 3: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- `QUERY_OPTIMIZATION` - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- `REDIS_CACHE` - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–∑–∞ 4: –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- `NOTIFICATIONS` - –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `ADVANCED_STATS` - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `TOURNAMENTS` - –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

### –®–∞–≥ 1: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (develop branch)
```javascript
// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —Ñ–ª–∞–≥–æ–º
if (isEnabled('MY_NEW_FEATURE')) {
  // –ù–æ–≤—ã–π –∫–æ–¥
} else {
  // –°—Ç–∞—Ä—ã–π –∫–æ–¥ (fallback)
}
```

### –®–∞–≥ 2: Staging (—Ñ–ª–∞–≥ –í–ö–õ–Æ–ß–ï–ù)
```bash
# –í Vercel staging environment
FEATURE_MY_NEW_FEATURE=true
```
–¢–µ—Å—Ç–∏—Ä—É–µ–º 24-48 —á–∞—Å–æ–≤

### –®–∞–≥ 3: Production (—Ñ–ª–∞–≥ –í–´–ö–õ–Æ–ß–ï–ù —Å–Ω–∞—á–∞–ª–∞)
```bash
# Deploy –Ω–∞ production, –Ω–æ —Ñ–ª–∞–≥ –≤—ã–∫–ª—é—á–µ–Ω
FEATURE_MY_NEW_FEATURE=false
```

### –®–∞–≥ 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ
```bash
# –î–µ–Ω—å 1: 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
FEATURE_MY_NEW_FEATURE=true  # + canary logic

# –î–µ–Ω—å 3: 50% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# –î–µ–Ω—å 7: 100% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

### –®–∞–≥ 5: –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ (—á–µ—Ä–µ–∑ –º–µ—Å—è—Ü)
–ö–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞, —É–¥–∞–ª—è–µ–º if/else –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–π –∫–æ–¥.

## ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. **–í—Å–µ–≥–¥–∞** –¥–æ–±–∞–≤–ª—è–π fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –∫–æ–¥
2. **–ù–∏–∫–æ–≥–¥–∞** –Ω–µ —É–¥–∞–ª—è–π —Ñ–ª–∞–≥ —Å—Ä–∞–∑—É - –∂–¥–∏ –º–∏–Ω–∏–º—É–º –º–µ—Å—è—Ü
3. **–í—Å–µ–≥–¥–∞** —Ç–µ—Å—Ç–∏—Ä—É–π –æ–±–µ –≤–µ—Ç–∫–∏ –∫–æ–¥–∞ (—Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω –∏ –≤—ã–∫–ª—é—á–µ–Ω)
4. **–í—Å–µ–≥–¥–∞** –ø–∏—à–∏ —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–æ–∏—Ö —Å–ª—É—á–∞–µ–≤

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–ª–∞–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
```javascript
window.FeatureFlags.getAllFlags()
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–ª–∞–≥
```javascript
window.FeatureFlags.isEnabled('NEW_AUTH_SYSTEM')
// => false
```

### –í API (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
```javascript
import { getAllFlags } from '../shared/feature-flags.js';
console.log('Current flags:', getAllFlags());
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞

### –ü—Ä–∏–º–µ—Ä 1: XSS Protection

**–ë—ã–ª–æ (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ):**
```javascript
element.innerHTML = `<h2>${userData}</h2>`;
```

**–°—Ç–∞–ª–æ (—Å feature flag):**
```javascript
import { isEnabled } from './shared/feature-flags.js';

if (isEnabled('XSS_PROTECTION')) {
  // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–±
  const h2 = document.createElement('h2');
  h2.textContent = userData;
  element.appendChild(h2);
} else {
  // –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (–Ω–∞ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏)
  element.innerHTML = `<h2>${userData}</h2>`;
}
```

### –ü—Ä–∏–º–µ—Ä 2: –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ auth

**–ë—ã–ª–æ:**
```javascript
const VALID_CREDENTIALS = { 'Egor': 'unnatov14' };
```

**–°—Ç–∞–ª–æ:**
```javascript
import { isEnabled } from '../../shared/feature-flags.js';

export default async function handler(req, res) {
  if (isEnabled('NEW_AUTH_SYSTEM')) {
    // JWT + bcrypt
    return handleJWTAuth(req, res);
  } else {
    // –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
    const VALID_CREDENTIALS = { 'Egor': 'unnatov14' };
    // ...—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞...
  }
}
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º

- [ ] –§–ª–∞–≥ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `shared/feature-flags.js`
- [ ] –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –æ–±–µ–∏—Ö –≤–µ—Ç–æ–∫ (–≤–∫–ª—é—á–µ–Ω–æ/–≤—ã–∫–ª—é—á–µ–Ω–æ)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π –∫–æ–¥
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (—Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (—Ñ–ª–∞–≥ –≤—ã–∫–ª—é—á–µ–Ω)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ staging —Å —Ñ–ª–∞–≥–æ–º –≤–∫–ª—é—á–µ–Ω–Ω—ã–º
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ø–ª–∞–Ω –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentry)

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:** 2025-01-12
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
