name: Health Check & Uptime Monitoring

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check API Health
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API Version
        id: version
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" https://mafclubscore.vercel.app/api/version)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Version endpoint failed with HTTP $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Version endpoint OK"

      - name: Check Rating API
        id: rating
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" https://mafclubscore.vercel.app/api/rating)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Rating endpoint failed with HTTP $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Rating endpoint OK"

      - name: Check Database Connection
        run: |
          RESPONSE=$(curl -s https://mafclubscore.vercel.app/api/rating)
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ
          if ! echo "$RESPONSE" | grep -q '"success":true'; then
            echo "‚ùå Database connection failed"
            exit 1
          fi
          echo "‚úÖ Database connection OK"

      - name: Check Day Stats API
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" https://mafclubscore.vercel.app/api/day-stats)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Day Stats endpoint failed"
            exit 1
          fi
          echo "‚úÖ Day Stats endpoint OK"

      - name: Response Time Check
        run: |
          START=$(date +%s%N)
          curl -s https://mafclubscore.vercel.app/api/version > /dev/null
          END=$(date +%s%N)
          
          DURATION=$(( (END - START) / 1000000 ))
          echo "Response time: ${DURATION}ms"
          
          if [ "$DURATION" -gt 3000 ]; then
            echo "‚ö†Ô∏è Slow response time: ${DURATION}ms"
          else
            echo "‚úÖ Response time OK: ${DURATION}ms"
          fi

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Health Check Failed';
            const body = `
            ## Health Check Failure Report
            
            **Time:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            ### Failed Checks:
            - Version API: ${{ steps.version.outputs.http_code }}
            - Rating API: ${{ steps.rating.outputs.http_code }}
            
            **Action Required:** Investigate production health
            
            [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–π issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check,automated'
            });
            
            if (issues.data.length === 0) {
              // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'automated', 'bug']
              });
            }
